<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trade Signal Generator - Smarter AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0d1117;
        }
        .glassmorphism {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-primary {
            background: linear-gradient(90deg, #3b82f6, #22d3ee);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        .btn-primary:disabled {
            background: #334155;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: #334155;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        #loader, .spinner {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        .upload-area:hover {
            border-color: #3b82f6;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn.selected {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5);
        }
        #ai-modal-backdrop {
            transition: opacity 0.3s ease;
        }
        #ai-modal-panel {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-slate-900 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">AI Trade Signal Generator Pro</h1>
            <p class="text-gray-400 mt-2">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏≤‡∏ü ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <!-- Options -->
        <div class="space-y-4">
            <div>
                <label class="font-semibold text-gray-300">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (Asset)</label>
                <div id="asset-options" class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
                    <button class="option-btn bg-slate-700 p-2 rounded-lg" data-value="BTC/USD">BTC/USD</button>
                    <button class="option-btn bg-slate-700 p-2 rounded-lg" data-value="XAU/USD">XAU/USD</button>
                    <button class="option-btn bg-slate-700 p-2 rounded-lg" data-value="ETH/USD">ETH/USD</button>
                    <button class="option-btn bg-slate-700 p-2 rounded-lg selected" data-value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
                </div>
            </div>
            <div>
                <label class="font-semibold text-gray-300">Timeframe</label>
                <div id="timeframe-options" class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
                    <button class="option-btn bg-slate-700 p-2 rounded-lg" data-value="15 ‡∏ô‡∏≤‡∏ó‡∏µ">15M</button>
                    <button class="option-btn bg-slate-700 p-2 rounded-lg" data-value="1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á">1H</button>
                    <button class="option-btn bg-slate-700 p-2 rounded-lg" data-value="4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á">4H</button>
                    <button class="option-btn bg-slate-700 p-2 rounded-lg selected" data-value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
                </div>
            </div>
        </div>

        <!-- Upload Area -->
        <div>
            <label for="chart-upload" class="upload-area flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer bg-slate-800 hover:bg-slate-700 transition-colors">
                <div id="upload-prompt" class="flex flex-col items-center justify-center pt-5 pb-6">
                    <svg class="w-10 h-10 mb-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
                    <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</span> ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á</p>
                    <p class="text-xs text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö PNG, JPG (‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏£‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)</p>
                </div>
                <img id="image-preview" src="" alt="Chart Preview" class="hidden h-full w-full object-contain rounded-lg"/>
                <input id="chart-upload" type="file" class="hidden" accept="image/png, image/jpeg" />
            </label>
        </div>

        <!-- Analyze Button -->
        <button id="analyze-btn" disabled class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center">
            <svg id="analyze-icon" class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
            <span id="analyze-text">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü</span>
            <div id="loader" class="hidden w-6 h-6 border-4 border-gray-500 rounded-full"></div>
        </button>

        <!-- Results Section -->
        <div id="results-container" class="hidden space-y-4">
            <div id="signal-header" class="text-center p-3 rounded-lg glassmorphism">
                <p class="text-lg font-bold" id="signal-direction">-</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="result-card glassmorphism p-4 rounded-lg fade-in"><p class="text-sm text-blue-300">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (Entry)</p><p id="entry-price" class="text-2xl font-bold">-</p></div>
                <div class="result-card glassmorphism p-4 rounded-lg fade-in" style="animation-delay: 0.1s;"><p class="text-sm text-green-300">‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£ (TP)</p><p id="take-profit" class="text-2xl font-bold">-</p></div>
                <div class="result-card glassmorphism p-4 rounded-lg fade-in" style="animation-delay: 0.2s;"><p class="text-sm text-red-400">‡∏ï‡∏±‡∏î‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (SL)</p><p id="stop-loss" class="text-2xl font-bold">-</p></div>
            </div>

            <div class="grid grid-cols-3 gap-4 text-center">
                 <div class="result-card glassmorphism p-4 rounded-lg fade-in" style="animation-delay: 0.3s;"><p class="text-sm text-yellow-300">Risk/Reward Ratio</p><p id="rr-ratio" class="text-2xl font-bold">-</p></div>
                 <div class="result-card glassmorphism p-4 rounded-lg fade-in" style="animation-delay: 0.4s;"><p class="text-sm text-purple-300">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (Confidence)</p><p id="confidence" class="text-2xl font-bold">-</p></div>
                 <div class="result-card glassmorphism p-4 rounded-lg fade-in" style="animation-delay: 0.5s;"><p class="text-sm text-indigo-300">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü (Pattern)</p><p id="chart-pattern" class="text-xl font-bold">-</p></div>
            </div>

            <div class="result-card glassmorphism p-4 rounded-lg fade-in" style="animation-delay: 0.6s;">
                <h3 class="font-semibold text-lg mb-2 flex items-center"><svg class="w-5 h-5 mr-2 text-cyan-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</h3>
                <p id="analysis-reasoning" class="text-gray-300 text-sm leading-relaxed">-</p>
            </div>
            
            <!-- ‚ú® New Gemini Features Section ‚ú® -->
            <div id="gemini-features" class="hidden space-y-2 pt-4 border-t border-slate-700">
                 <h3 class="text-center font-semibold text-cyan-300">‚ú® AI Power-Ups ‚ú®</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <button id="news-btn" class="btn-secondary p-2 rounded-lg text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß & Sentiment</button>
                    <button id="eli5-btn" class="btn-secondary p-2 rounded-lg text-sm">‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ</button>
                    <button id="plan-btn" class="btn-secondary p-2 rounded-lg text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î</button>
                 </div>
            </div>
        </div>

        <div id="disclaimer" class="hidden text-center text-xs text-gray-500 p-2 glassmorphism rounded-lg fade-in">
             <p><strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏ß‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</p>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="ai-modal-backdrop" class="fixed inset-0 bg-black/60"></div>
        <div id="ai-modal-panel" class="relative w-full max-w-lg glassmorphism rounded-2xl shadow-lg mx-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="ai-modal-title" class="text-xl font-bold text-cyan-300"></h3>
                    <button id="ai-modal-close-btn" class="text-gray-400 hover:text-white">&times;</button>
                </div>
                <div id="ai-modal-content" class="text-gray-300 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const uploadInput = document.getElementById('chart-upload');
        const imagePreview = document.getElementById('image-preview');
        const uploadPrompt = document.getElementById('upload-prompt');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resultsContainer = document.getElementById('results-container');
        const disclaimer = document.getElementById('disclaimer');
        const loader = document.getElementById('loader');
        const analyzeText = document.getElementById('analyze-text');
        const analyzeIcon = document.getElementById('analyze-icon');
        const assetOptions = document.getElementById('asset-options');
        const timeframeOptions = document.getElementById('timeframe-options');

        // Result fields
        const signalDirectionEl = document.getElementById('signal-direction');
        const signalHeaderEl = document.getElementById('signal-header');
        const entryPriceEl = document.getElementById('entry-price');
        const takeProfitEl = document.getElementById('take-profit');
        const stopLossEl = document.getElementById('stop-loss');
        const rrRatioEl = document.getElementById('rr-ratio');
        const confidenceEl = document.getElementById('confidence');
        const chartPatternEl = document.getElementById('chart-pattern');
        const analysisReasoningEl = document.getElementById('analysis-reasoning');

        // ‚ú® New Gemini Features Elements ‚ú®
        const geminiFeaturesEl = document.getElementById('gemini-features');
        const newsBtn = document.getElementById('news-btn');
        const eli5Btn = document.getElementById('eli5-btn');
        const planBtn = document.getElementById('plan-btn');

        // Modal Elements
        const aiModal = document.getElementById('ai-modal');
        const aiModalBackdrop = document.getElementById('ai-modal-backdrop');
        const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiModalContent = document.getElementById('ai-modal-content');
        
        // --- State ---
        let imageBase64Data = null;
        let selectedAsset = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        let selectedTimeframe = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        let currentTradeSignal = null; // To store the full signal object
        let currentReasoning = ""; // To store the reasoning text

        // --- Event Listeners ---
        function setupOptionButtons(container, stateUpdater) {
            container.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    container.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    stateUpdater(e.target.dataset.value);
                }
            });
        }

        setupOptionButtons(assetOptions, (value) => selectedAsset = value);
        setupOptionButtons(timeframeOptions, (value) => selectedTimeframe = value);

        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imageBase64Data = e.target.result.split(',')[1];
                    imagePreview.classList.remove('hidden');
                    uploadPrompt.classList.add('hidden');
                    analyzeBtn.disabled = false;
                    resultsContainer.classList.add('hidden');
                    geminiFeaturesEl.classList.add('hidden');
                    disclaimer.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        analyzeBtn.addEventListener('click', async () => {
            if (!imageBase64Data) return;
            setLoadingState(true);
            try {
                // --- SMARTER PROMPT v2 ---
                const prompt = `
                ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô (Institutional-Grade Technical Analyst) ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô Price Action, Market Structure, ‡πÅ‡∏•‡∏∞ Multi-Timeframe Analysis.
                
                ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå ${selectedAsset} ‡πÉ‡∏ô Timeframe ${selectedTimeframe} ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                1.  **Multi-Timeframe Context:** ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô Timeframe ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô Daily, Weekly) ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î Bias ‡∏´‡∏•‡∏±‡∏Å (Bullish/Bearish).
                2.  **Market Structure Analysis:** ‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏•‡∏≤‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ Higher Highs/Higher Lows ‡∏´‡∏£‡∏∑‡∏≠ Lower Highs/Lower Lows).
                3.  **Key Level & Liquidity:** ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö/‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô (Support/Resistance) ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÄ‡∏õ‡πá‡∏ô Liquidity Zone.
                4.  **Chart Pattern Identification:** ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô Head and Shoulders, Double Top, Bull Flag, Ascending Triangle).
                5.  **Candlestick Confirmation:** ‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô (Confirmation Candle) ‡∏ó‡∏µ‡πà Key Level.
                6.  **Signal Formulation:** ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏π‡∏á.

                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô JSON object ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå.
                **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 'reasoning' ‡πÉ‡∏´‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÑ‡∏ß‡πâ.
                ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏î‡πÜ ‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å JSON ‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠.
                `;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imageBase64Data } }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "entryPrice": { "type": "STRING" }, "takeProfit": { "type": "STRING" }, "stopLoss": { "type": "STRING" },
                                "reasoning": { "type": "STRING" }, "tradeDirection": { "type": "STRING", "enum": ["Long", "Short", "Buy", "Sell"] },
                                "confidence": { "type": "STRING", "enum": ["High", "Medium", "Low"] }, "riskRewardRatio": { "type": "STRING" },
                                "chartPattern": { "type": "STRING", "description": "The specific chart pattern identified, e.g., 'Bullish Engulfing at Support'" }
                            },
                            required: ["entryPrice", "takeProfit", "stopLoss", "reasoning", "tradeDirection", "confidence", "riskRewardRatio", "chartPattern"]
                        }
                    }
                };
                const tradeSignal = await callGeminiAPI(payload);
                displayResults(tradeSignal);
                currentTradeSignal = tradeSignal; // Save for other features
                currentReasoning = tradeSignal.reasoning;
                geminiFeaturesEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error during analysis:', error);
                displayError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: ' + error.message);
            } finally {
                setLoadingState(false);
            }
        });

        // --- ‚ú® Smarter Gemini Features Handlers ‚ú® ---

        newsBtn.addEventListener('click', async () => {
            showModal('‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞ Sentiment ‡∏ï‡∏•‡∏≤‡∏î', '<div class="w-6 h-6 spinner rounded-full border-4 border-gray-500 mx-auto"></div>');
            try {
                const mockHeadlines = `1. 'Fed Chair hints at slower rate hikes, boosting risk assets.' 2. 'Major exchange reports record ${selectedAsset} outflows, suggesting accumulation.' 3. 'Geopolitical tensions in Europe create market uncertainty.' 4. 'Technical analyst from Goldman Sachs calls for a short-term correction in ${selectedAsset}.'`;
                const prompt = `‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Sentiment, ‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ${selectedAsset} ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ: "${mockHeadlines}" ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢:
                1.  **‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°:** ‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î.
                2.  **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Sentiment:** ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Bullish, Bearish, ‡∏´‡∏£‡∏∑‡∏≠ Mixed/Neutral.
                3.  **‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Sentiment (‡πÄ‡∏ï‡πá‡∏° 10):** ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á Sentiment (‡πÄ‡∏ä‡πà‡∏ô Bullish 8/10).
                4.  **‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:** ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏ô‡∏±‡πâ‡∏ô.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const resultText = await callGeminiAPI(payload, false);
                showModal('‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞ Sentiment ‡∏ï‡∏•‡∏≤‡∏î', resultText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'));
            } catch (error) {
                showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message);
            }
        });

        eli5Btn.addEventListener('click', async () => {
            if (!currentReasoning) return;
            showModal('‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ', '<div class="w-6 h-6 spinner rounded-full border-4 border-gray-500 mx-auto"></div>');
            try {
                const prompt = `‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ô‡∏µ‡πâ: "${currentReasoning}" ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ó‡∏£‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏•‡∏≠‡∏á‡∏ô‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö..." ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const resultText = await callGeminiAPI(payload, false);
                showModal('‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ', resultText.replace(/\n/g, '<br>'));
            } catch (error) {
                showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message);
            }
        });

        planBtn.addEventListener('click', async () => {
            if (!currentTradeSignal) return;
            showModal('‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå', '<div class="w-6 h-6 spinner rounded-full border-4 border-gray-500 mx-auto"></div>');
            try {
                const signalString = `‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á: ${currentTradeSignal.tradeDirection}, ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤: ${currentTradeSignal.entryPrice}, TP: ${currentTradeSignal.takeProfit}, SL: ${currentTradeSignal.stopLoss}, ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü: ${currentTradeSignal.chartPattern}`;
                const prompt = `‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ó‡∏£‡∏î‡∏ô‡∏µ‡πâ: "${signalString}", ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á "‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå" ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:
                1.  **‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (Risk Management):** ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î Position Size ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà 1% ‡∏Ç‡∏≠‡∏á‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ç‡∏ô‡∏≤‡∏î $10,000.
                2.  **‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å (Entry/Exit Strategy):** ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏°‡πâ‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Scaling in/out) ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô.
                3.  **‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏£‡∏î (Trade Management):** ‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Stop Loss ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô (Break-even).
                4.  **‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏à‡∏∞‡∏•‡πà‡∏° (Invalidation Scenario):** ‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏∂‡∏á SL ‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏µ‡∏Å‡∏ö‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const resultText = await callGeminiAPI(payload, false);
                showModal('‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå', resultText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'));
            } catch (error) {
                showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message);
            }
        });

        // --- API Call Function ---
        async function callGeminiAPI(payload, expectJson = true) {
            const apiKey = ""; // Provided by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API request failed: ${errorBody}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts?.[0]) {
                const part = result.candidates[0].content.parts[0];
                return expectJson ? JSON.parse(part.text) : part.text;
            } else {
                throw new Error("Invalid response structure from AI.");
            }
        }

        // --- UI Functions ---
        function setLoadingState(isLoading) {
             if (isLoading) {
                analyzeBtn.disabled = true;
                analyzeText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';
                analyzeIcon.classList.add('hidden');
                loader.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                geminiFeaturesEl.classList.add('hidden');
                disclaimer.classList.add('hidden');
            } else {
                analyzeBtn.disabled = false;
                analyzeText.textContent = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü';
                analyzeIcon.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }
        
        function displayError(message) {
            resultsContainer.classList.remove('hidden');
            signalHeaderEl.classList.remove('bg-green-500/30', 'bg-red-500/30', 'border-green-400', 'border-red-400').add('bg-yellow-500/30', 'border-yellow-400');
            signalDirectionEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
            analysisReasoningEl.textContent = message;
            entryPriceEl.textContent = '-'; takeProfitEl.textContent = '-'; stopLossEl.textContent = '-';
            rrRatioEl.textContent = '-'; confidenceEl.textContent = '-'; chartPatternEl.textContent = '-';
        }

        function displayResults(data) {
            entryPriceEl.textContent = data.entryPrice || '-'; takeProfitEl.textContent = data.takeProfit || '-';
            stopLossEl.textContent = data.stopLoss || '-'; rrRatioEl.textContent = data.riskRewardRatio || '-';
            confidenceEl.textContent = data.confidence || '-'; analysisReasoningEl.textContent = data.reasoning || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢';
            chartPatternEl.textContent = data.chartPattern || '-';

            signalHeaderEl.classList.remove('bg-green-500/30', 'bg-red-500/30', 'border-green-400', 'border-red-400', 'bg-yellow-500/30', 'border-yellow-400');
            const direction = data.tradeDirection?.toLowerCase();
            if (direction === 'long' || direction === 'buy') {
                signalDirectionEl.textContent = 'üìà ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠ (BUY)';
                signalHeaderEl.classList.add('bg-green-500/30', 'border-green-400');
            } else if (direction === 'short' || direction === 'sell') {
                signalDirectionEl.textContent = 'üìâ ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏¢ (SELL)';
                signalHeaderEl.classList.add('bg-red-500/30', 'border-red-400');
            } else {
                signalDirectionEl.textContent = '‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì';
            }
            resultsContainer.classList.remove('hidden');
            disclaimer.classList.remove('hidden');
        }

        // --- Modal Functions ---
        function showModal(title, content) {
            aiModalTitle.textContent = title;
            aiModalContent.innerHTML = content;
            aiModal.classList.remove('hidden');
        }
        function hideModal() {
            aiModal.classList.add('hidden');
        }
        aiModalCloseBtn.addEventListener('click', hideModal);
        aiModalBackdrop.addEventListener('click', hideModal);

    </script>
</body>
</html>
